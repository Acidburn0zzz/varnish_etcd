# Construct a backend for each container's IP
<% domains.each_pair do |domain, hostnames| %>
 <% hostnames.each_with_index do | hostname, index | %>
backend <%= domain + index.to_s %> {
  .host = "<%= hostname["hostname"] %>";
  .port = "<%= hostname["port"] %>";
  .probe = {
    .url = "/";
    .interval = 30s;
    .timeout = 10s;
    .window= 5;
    .threshold = 2;
  }
}
  <% end %>
director <%= domain + "_backend" %> round-robin {
  <% hostnames.each_with_index do | hostname, index | %>
  {
    .backend = <%= domain + index.to_s %>;
  }
  <% end %>
}
<% end %>

# Respond to incoming requests and route accordingly
sub vcl_recv {
<% domains.each_pair do |domain, hostnames| %>
  if(req.http.host == "<%= domain  %>") {
    set req.backend = <%= domain + "_backend" %>;
    return (lookup);
  }
}
<% end %>

# Output backend container serving the request
sub vcl_fetch {
    set beresp.http.X-Backend = beresp.backend.name;
}
